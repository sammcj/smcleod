<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>XenServer, SSDs & VM Storage Performance &#8211; smcleod.net</title>
<meta name="description" content="Brian Dump Of Sam McLeod, Melbourne">
<meta name="keywords" content="ops, storage, ssd">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">
<meta name="twitter:title" content="XenServer, SSDs & VM Storage Performance">
<meta name="twitter:description" content="Brian Dump Of Sam McLeod, Melbourne">
<meta name="twitter:creator" content="@s_mcleod">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="XenServer, SSDs & VM Storage Performance">
<meta property="og:description" content="Brian Dump Of Sam McLeod, Melbourne">
<meta property="og:url" content="/xenserver-ssds--vm-storage-performance/">
<meta property="og:site_name" content="smcleod.net">





<link rel="canonical" href="/xenserver-ssds--vm-storage-performance/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="smcleod.net Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




<style type="text/css">body {background-image:url(/images/black_lozenge.png);}</style>


</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Sam McLeod photo" class="author-photo">
					<h4>Sam McLeod</h4>
					<p>Ops Lead @Infoxchange</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:smj(at)fastmail(dot)com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/s_mcleod"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				
				<li>
					<a href="http://linkedin.com/in/au.linkedin.com/in/sammcj/en"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/sammcj"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="http://mondotunes.org" target="_blank">Mondotunes</a></li>
	  
	    
	    <li><a href="http://last.fm/user/sammcj2000" target="_blank">Last.fm</a></li>
	  
	    
	    <li><a href="http://ixa.io" target="_blank">Infoxchange Tech Blog</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/xenserver-ssds--vm-storage-performance/" rel="bookmark" title="XenServer, SSDs & VM Storage Performance">XenServer, SSDs & VM Storage Performance</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2015-02-15T00:00:00+11:00">February 15, 2015</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~5 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h2 id="intro">Intro</h2>

<p>At Infoxchange we use XenServer as our Virtualisation of choice.
There are many reasons for this including:</p>

<ul>
  <li>Open Source.</li>
  <li>Offers greater performance than VMware.</li>
  <li>Affordability (it’s free unless you purchase support).</li>
  <li>Proven backend Xen is very reliable.</li>
  <li>Reliable cross-host migrations of VMs.</li>
  <li>The XenCentre client, (although having to run in a Windows VM) is quick and simple to use.</li>
  <li>Upgrades and patches have proven to be more reliable than VMware.</li>
  <li>OpenStack while interesting, is not yet reliable or streamlined enough for our small team of 4 to implement and manage.</li>
  <li>XenServer Storage &amp; Filesystems</li>
</ul>

<!--more-->

<p>Unfortunately the downside to XenServer is that it’s underlying OS is quite old.
The latest version (6.5) about to be released is still based on Centos 5 and still lacks any form of EXT4 and BTRFS support, direct disk access is not available… without some tweaking and has no real support for TRIM unless you have direct disk access and are happy with EXT3.</p>

<p>Despite this, XenServer still manages to easily outperform VMware in both storage and CPU performance while costing… nothing unless you purchase support!</p>

<h2 id="direct-disk-access">Direct disk access</h2>

<p>It turns out, that you can add custom udev rules to pass through devices directly to VMs.</p>

<p>For example, assuming <code>/dev/sdb</code> is the disk you wish to make available to guests, you can edit <code>/etc/udev/rules.d/50-udev.rules</code> like so:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;sdb&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;xapi/block/%k&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/bin/sh -c &#39;/opt/xensource/libexec/local-device-change %k 2&gt;&amp;1 &gt;/dev/null&amp;&#39;&quot;</span>
<span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;remove&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;sdb&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/bin/sh -c &#39;/opt/xensource/libexec/local-device-change %k 2&gt;&amp;1 &gt;/dev/null&amp;&#39;&quot;</span></code></pre></div>

<p>There are some limitations with this:</p>

<p>You’re passing through the whole disk and can only grant that entire disk to a single VM.
The udev configuration is volitile and is likely to be lost upon installing XenServer updates.
You cannot (to my knowledge) boot from directly attached storage devices.
What I’ve actually done is partitioned the SSD RAID array into 4 paritions on the XenServer host, this allows me to carve up the SSD RAID array and present adiquit storage to several VMs on the host.
i.e.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;sdb1&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;xapi/block/%k&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/bin/sh -c &#39;/opt/xensource/libexec/local-device-change %k 2&gt;&amp;1 &gt;/dev/null&amp;&#39;&quot;</span>
<span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;remove&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;sdb1&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/bin/sh -c &#39;/opt/xensource/libexec/local-device-change %k 2&gt;&amp;1 &gt;/dev/null&amp;&#39;&quot;</span>
<span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;sdb2&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;xapi/block/%k&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/bin/sh -c &#39;/opt/xensource/libexec/local-device-change %k 2&gt;&amp;1 &gt;/dev/null&amp;&#39;&quot;</span>
<span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;remove&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;sdb2&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/bin/sh -c &#39;/opt/xensource/libexec/local-device-change %k 2&gt;&amp;1 &gt;/dev/null&amp;&#39;&quot;</span></code></pre></div>

<p>etc…</p>

<p>I’ve then:</p>

<ul>
  <li>Mapped each partition to a VM running on that host.</li>
  <li>Partitioned it within the host as needed.</li>
  <li>Mounted /var/lib/docker as a BTRFS volume with compression enabled (compress=lzo) – This is used by CI as we build our our applications in Docker.</li>
  <li>Mounted /home as an EXT4 – This is used by Gitlab-CI to checkout the pre-reqs for each build.</li>
</ul>

<h2 id="performance-benchmarks">Performance (benchmarks)</h2>

<h3 id="observations">Observations</h3>

<p>The HP P410i RAID card on the old G6 DL360’s I am using for this is far underpowered and is unable to perform anywhere near the SSD’s rated speeds.
Direct disk access is 2-6 times ‘faster’ than XenServer’s standard LVM or EXT3 storage.
There is less than a 10% difference in performance between the SSD RAID array on the VM with the presented disk than directly on the XenServer host.
XenServer’s raw disk performance was exactly the same as Debian 7.
Remember to ensure your RAID (and disk cache if not in prod) is enabled!
Points of Note:</p>

<p>This is an old server, we’re not talking your latest and greatest hardware here, we’re talking giving new life to an old-ish dog so that it may retain its usefulness while remaining cost effective.
With TRIM being unavailable when using RAID, it is expected that the write performance will decrease somewhat overtime as the disks fill up as the disks will have to perform a ‘READ, ERASE, WRITE’ rather than a simple WRITE, To aid the lack of TRIM, I have left more than 25% of the disks unused as we simply don’t need 1TB of SSD storage on each of the hosts.
We have some 1GB cache cards arriving in the following weeks which we will upgrade to from the 512MB cards presently installed – I expect this to significantly further improve performance.</p>

<h2 id="hardware">Hardware:</h2>

<ul>
  <li>Refurbished HP DL360 G6 (2010 model).</li>
  <li>2x 8 Core Xeon x5550 w/ hyperthreading, 8 cores presented to domU.</li>
  <li>96GB DDR3 in dom0, 4GB in domU.</li>
  <li>HP P410i w/ 512MB cache.</li>
  <li>2x 10K 146GB spindles for dom0.</li>
  <li>‘HP Genuine’!</li>
  <li>Constant 5-6 Watts each + cooling.</li>
  <li>2x SanDisk Extreme Pro SSD 480GB in RAID 0</li>
  <li>SATA III, Read up to 550MB/s, Write up to 515MB/s, Random Read up to 100K IOPS, Random Write up to 90K IOPS.</li>
  <li>0.15-0.2 Watts peak each.</li>
</ul>

<p>EXT4 Bonnie++ Results w/ 2x SSD in RAID1, XenServer 6.5 RC1, LVM:</p>

<p><img src="images/xenserver/dl360-lvm.jpg" alt="" /></p>

<p>EXT4 Bonnie++ Results w/ 2x SSD in RAID1, XenServer 6.5 RC1, Direct Disk:</p>

<p><img src="images/xenserver/dl360-dd.jpg" alt="" /></p>

<p>EXT4 dd Results w/ 2x SSD in RAID0, XenServer 6.5 RC1, LVM:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">samm@serv-dhcp-13:/var/tmp# dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>tempfile <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">8000</span> <span class="nv">conv</span><span class="o">=</span>fdatasync,notrunc
 8000+0 records in
 8000+0 records out
 <span class="m">8388608000</span> bytes <span class="o">(</span>8.4 GB<span class="o">)</span> copied, 118.11 s, 71.0 MB/s</code></pre></div>

<p>EXT4 dd Results w/ 2x SSD in RAID0, XenServer 6.5 RC1, Direct Disk:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">samm@serv-dhcp-13:/var/tmp# dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>tempfile <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">8000</span> <span class="nv">conv</span><span class="o">=</span>fdatasync,notrunc
 8000+0 records in
 8000+0 records out
 <span class="m">8388608000</span> bytes <span class="o">(</span>8.4 GB<span class="o">)</span> copied, 19.21 s, <span class="m">437</span> MB/s</code></pre></div>

<p>Future Benchmarking Steps</p>

<ul>
  <li>Observe performance over time since TRIM is not available.</li>
  <li>Upgrade RAID cards to 1GB cache (we have some spares).</li>
  <li>Try with our new Gen8 BL460c blade servers, with locally attached P420i RAID controllers and 2GB cache.</li>
  <li>Try linux software RAID with direct disks.</li>
</ul>

<h2 id="xenservers-future">XenServer’s Future</h2>

<p>Filesystems</p>

<p>I would hope that both EXT4 (and BTRFS) support is added in the near future.
With this I would expect auto-detecting TRIM support similar to VMware and Hyper-V.
Direct Disk Access</p>

<p>Direct disk access clearly offers massive performance gains, I would like to see XenServer add this as an easy to use option when configuring storage.
Non-volitile advanced configuration</p>

<p>Related to direct disk access, XenServer needs some form of non-volitle advanced configuration options.
VMware, raw Xen and KVM let you tweak many options without risk of loss after installing minor updates.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#ops" title="Pages tagged ops" class="tag"><span class="term">ops</span></a><a href="/tags/#storage" title="Pages tagged storage" class="tag"><span class="term">storage</span></a><a href="/tags/#ssd" title="Pages tagged ssd" class="tag"><span class="term">ssd</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/xenserver-ssds--vm-storage-performance/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/xenserver-ssds--vm-storage-performance/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/xenserver-ssds--vm-storage-performance/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/the-best-of--2014-edition/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/the-best-of--2014-edition/" title="The Best Of - 2014 Edition">The Best Of - 2014 Edition</a></h3>
      <p>At the end of every year I note down a summary of the best applications, hardware &amp; websites I’ve enjoyed &amp; depended on throughou...&hellip; <a href="/the-best-of--2014-edition/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/talk-24-months/" title="Talk - 24 Months">Talk - 24 Months</a></h4>
        <span>Published on February 15, 2015</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/search--a-journey-of-delivery-on-a-budget/" title="Search – A Journey of Delivery on a Budget">Search – A Journey of Delivery on a Budget</a></h4>
        <span>Published on February 15, 2015</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Sam McLeod. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/" rel="notfollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59178670-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'hpstrtheme'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
